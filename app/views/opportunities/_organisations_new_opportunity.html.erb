<%# This file is rendered in the pages/organisations_host.html.erb %>
<div class="row">
  <div class="col l12">
  <%# Find the name of each organisation %>
  <% current_user.organisations.each do |organisation| %>
    <%# the @organisation appears here only because it is required for rendering "organisations/subscription_button" below %>
    <% @organisation = Organisation.find(organisation.id) %>
    <%# Find the record in org_users join table of that user and that organisation, check the verification status %>
    <!-- <div class="row"> -->
    <% organisation.org_users.each do |org_user| %>
      <% if org_user.user_id == current_user.id %>
        <%# the host can click on New Opportunity button if:
            1. the Organisation Executive has verified his details
            AND
            2. the Admin has approved his registration
        %>
        <% if (org_user.verified_status) && (org_user.user.org_user_profile.approved)  %>
          <div class="card">
            <div class="card-content">
              <div class="col l8">
                <p>
                  Your connection with <b><%= link_to organisation.name, organisation_path(organisation.id) %></b> has been verified.
                  <br>
                  <%# There is an identical subscription process below in another file:
                      app/views/organisations/show.html.erb
                  %>
                  <% if organisation.subscriptions.present? %>
                    <%# searching for the LAST subscription of this ORGANISATION %>
                    <% @subscription = Subscription.find(organisation.subscriptions.last.id) %>
                    The subscription's expiry date is: <b><%= organisation.subscriptions.last.expiry_date.getlocal.strftime('%e %B %Y') %></b>
                    <% if (@subscription.active) %>
                      <% if @subscription.expires_in_less_than_30_days %>
                        - <span class="red-text bold">Expiring soon!</span>
                        <br>
                        <% if org_user.is_admin_user %><%# only admin host can view Subscription button %>
                          <%= render 'organisations/subscription_button' %>
                        <% elsif org_user.is_host_user %>
                          Please contact your organisation Host Administrators in the Organisation profile.
                          <br><br>
                        <% end %>
                      <% end %>
                      <%# if the host is verified and if the organisation subscription is active, host can create a new opportunity here %>
                      <div class="margin-bottom-20px">
                        <%= link_to 'New Opportunity', new_opportunity_path(org_id: organisation.id, object: 'title'), class: 'btn' %>
                      </div>
                    <% elsif (@subscription.expired)%>
                      - <span class="red-text bold">Expired!</span>
                      <br>
                      <% if org_user.is_admin_user %><%# only admin host can view Subscription button %>
                        <%= render 'organisations/subscription_button' %>
                      <% elsif org_user.is_host_user %>
                        Please contact your organisation Host Administrators in the Organisation profile.
                        <br><br>
                      <% end %>
                      <%# if host is verified but if the organisation subscription has expired, host can't create a new opportunity here %>
                      <a class="btn disabled margin-bottom-20px">New Opportunity</a>
                    <% end %>
                  <% else %>
                    There is no MOBEEAS subscription record for <%= organisation.name %>.<br>
                    <% if org_user.is_admin_user %><%# only admin host can view Subscription button %>
                      <%= render 'organisations/subscription_button' %>
                    <% elsif org_user.is_host_user %>
                      Please contact your organisation Host Administrators in the Organisation profile.
                      <br><br>
                    <% end %>
                    <%# if host is verified but if the organisation subscription is active, host can't create a new opportunity here %>
                    <a class="btn disabled margin-bottom-20px">New Opportunity</a>
                  <% end %>
                </p>
              </div>
              <% if @flag == 'active-current' %>
                <div class="col l4 margin-bottom-20px">
                  <%# if verified and if the organisation subscription is active, host can create a new opportunity here %>
                  <%= link_to 'New Opportunity', new_opportunity_path(org_id: organisation.id, object: 'title'), class: 'btn' %>
                </div>
              <% elsif @flag == 'expired' %>
                <div class="col l4 margin-bottom-20px">
                  <%# if verified and if the organisation subscription is active, host can create a new opportunity here %>
                  <a class="btn disabled">New Opportunity</a>
                </div>
              <% end %>
            </div>
          </div>

        <%# the host can't click the New Opportunity button if:
            1. the Organisation Executive has not approved his details
            OR
            2. the Admin has not approved his registration.
        %>
        <% elsif !(org_user.verified_status) || !(org_user.user.org_user_profile.approved) %>
          <div class="card">
            <div class="card-content">
              <div class="col l8">
                <p>
                  Your connection with <b><%= link_to organisation.name, organisation_path(organisation.id) %></b> has not been verified or your MOBEEAS registration has not yet been approved.
                </p>
              </div>
              <div class="col l4 margin-bottom-20px">
                <%# if not verified, host can not create a new opportunity here %>
                <a class="btn disabled">New Opportunity</a>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %><%# end of organisation.org_users loop %>
  <% end %><%# end of current_user.organisations %>
</div>
</div>
